<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ثبت نام</title>
  <link rel="stylesheet" href="../css/signup.css" />
  <link rel="stylesheet" href="../css/colors.css" />
  <link rel="stylesheet" href="../fonts/fonts.css" />
  <style>
    .message { padding: 12px; margin: 10px 0; border-radius: 5px; text-align: center; display:none; font-size:14px; }
    .message.success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .message.error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
  </style>
</head>
<body>
<div id="vanta-bg"></div>

<div class="register_bacground">
  <div class="register_container">
    <div class="login_title"><span>فرم ثبت نام</span></div>
    <div class="signup_form">
      <form id="signupForm" novalidate>
        <input type="text" id="username" placeholder="نام کاربری" required />
        <!-- <input type="number" id="phone-number" placeholder="شماره تلفن"> -->
        <input type="email" id="email" placeholder="ایمیل" required />
        <input type="password" id="password" placeholder="رمز عبور" minlength="8" required />
        <input type="password" id="re_password" placeholder="تکرار رمز عبور" required />
        <input type="submit" value="ثبت نام" id="submitBtn" />
      </form>
      <div id="message" class="message"></div>
    </div>
    <div class="login_bottom_links">
      <a href="forget-password.html">رمز عبورتان را فراموش کرده‌اید؟ <div class="blue">بازیابی رمز عبور</div></a>
      <a href="login.html">اگر حساب کاربری دارید <div class="blue">ورود کنید</div></a>
    </div>
  </div>
</div>

<script src="../js/libraries/register-bg.js"></script>
<script src="../js/libraries/register-bg2.js"></script>
<script>
const API_BASE = "https://atom-game.ir";
function showMsg(type,text){const box=document.getElementById("message");box.className="message "+type;box.innerText=text;box.style.display="block";}
function normalizeErrors(data){
  if(!data) return "خطای ناشناخته.";
  if(typeof data==="string") return data;
  if(Array.isArray(data)) return data.join("، ");
  if(data.detail) return data.detail;
  if(data.non_field_errors) return data.non_field_errors.join("، ");
  return Object.entries(data).map(([k,v])=>`${k}: ${v}`).join(" | ");
}

document.getElementById("signupForm").addEventListener("submit",async e=>{
  e.preventDefault();
  showMsg("",""); document.getElementById("message").style.display="none";
  const btn=document.getElementById("submitBtn"); btn.disabled=true; btn.value="درحال ارسال...";
  const payload={
    username:username.value.trim(),
    email:email.value.trim(),
    password:password.value,
    re_password:re_password.value
  };
  if(payload.password!==payload.re_password){showMsg("error","رمز عبور و تکرار آن مطابقت ندارند.");btn.disabled=false;btn.value="ثبت نام";return;}

  try{
    const res=await fetch(`${API_BASE}/auth/users/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const data=await res.json();
    if(res.status===201){
      showMsg("success","ثبت‌نام موفق! لطفا ایمیل خود را برای فعال‌سازی بررسی کنید.");
      setTimeout(()=>location.href="login.html",3000);
    }else{
      showMsg("error",normalizeErrors(data));
    }
  }catch(err){showMsg("error","خطا در اتصال به سرور");}
  finally{btn.disabled=false;btn.value="ثبت نام";}
});
</script>
</body>
</html>
